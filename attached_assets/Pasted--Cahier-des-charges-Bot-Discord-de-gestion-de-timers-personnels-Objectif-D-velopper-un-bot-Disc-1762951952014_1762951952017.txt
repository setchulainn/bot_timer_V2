 Cahier des charges â€“ Bot Discord de gestion de timers personnels
 Objectif
DÃ©velopper un bot Discord en Node.js (discord.js v14) permettant Ã  chaque utilisateur de :
â€¢	CrÃ©er et gÃ©rer plusieurs timers personnels.
â€¢	ÃŠtre notifiÃ© en message privÃ© Ã  la fin du timer.
â€¢	Visualiser tous ses timers actifs ou terminÃ©s via un message rÃ©capitulatif en DM.
â€¢	Annuler ses timers via des rÃ©actions dâ€™Ã©mojis.
________________________________________
 1. Structure gÃ©nÃ©rale
â€¢	Langage : JavaScript (Node.js)
â€¢	Librairies :
o	discord.js v14
o	express (ping uptime)
o	fs (sauvegarde locale)
â€¢	Persistance : fichier JSON (timers.json)
â€¢	HÃ©bergement compatible : Render, Replit ou tout service supportant Node.js
________________________________________
2. Fonctionnement gÃ©nÃ©ral du bot
2.1 DÃ©marrage
â€¢	Le bot dÃ©marre via client.login(DISCORD_BOT_TOKEN).
â€¢	Un mini-serveur Express est lancÃ© sur le port process.env.PORT pour rÃ©pondre Ã  UptimeRobot.
â€¢	Au dÃ©marrage :
o	Le fichier timers.json est chargÃ©.
o	Les timers encore valides sont reprogrammÃ©s.
o	Les messages rÃ©capitulatifs des utilisateurs sont rÃ©gÃ©nÃ©rÃ©s et mis Ã  jour.
________________________________________
 3. Gestion des timers
3.1 Commande Slash /add-timer
â€¢	Nom : add-timer
â€¢	Description : crÃ©e un nouveau timer avec notification privÃ©e.
â€¢	Options :
o	texte (string, requis) : description du timer.
o	duree (string, requis) : durÃ©e du timer (voir formats ci-dessous).
RÃ©ponse :
â€¢	Si la durÃ©e est valide â†’ message Ã©phÃ©mÃ¨re confirmant la crÃ©ation :
â€¢	â±ï¸ Timer **<texte>** dÃ©marrÃ© !
â€¢	Si le format est invalide â†’ erreur Ã©phÃ©mÃ¨re :
â€¢	âŒ Format invalide. Utilisez `2h30m`, `1d5h`, etc.
________________________________________
 4. Formats de durÃ©e acceptÃ©s
4.1 Formats supportÃ©s par parseDuration()
Le bot accepte les durÃ©es composÃ©es de jours, heures et minutes dans presque toutes les combinaisons :
Exemple saisie	InterprÃ©tation	RÃ©sultat
1d	1 jour	86 400 000 ms
2h	2 heures	7 200 000 ms
45m	45 minutes	2 700 000 ms
1d2h30m	1 jour, 2 heures, 30 min	95 400 000 ms
3h15 (sans â€œmâ€)	3h15min	11 700 000 ms
2h30m	2 heures 30 min	9 000 000 ms
Le â€œmâ€ (minutes) est optionnel.
Si la saisie ne contient aucun nombre valide, la commande Ã©choue.
4.2 Expression rÃ©guliÃ¨re utilisÃ©e :
/^(?:(\d+)d)?(?:(\d+)h)?(?:(\d+)m?)?$/i
________________________________________
 5. Notifications Ã  la fin dâ€™un timer
Quand un timer expire :
â€¢	Le bot envoie un DM privÃ© Ã  lâ€™utilisateur :
â€¢	âŒ› Votre timer **<texte>** s'est terminÃ© <t:timestamp:R> !
â€¢	Le timer est marquÃ© comme â€œterminÃ©â€ (champ ended: true).
â€¢	Le message rÃ©capitulatif est automatiquement mis Ã  jour.
________________________________________
 6. Message rÃ©capitulatif (DM rÃ©sumÃ©)
6.1 Contenu du message
Le bot maintient un seul message par utilisateur contenant la liste de tous ses timers :
â€¢	Embed Discord :
o	Titre : â±ï¸ Gestion des timers
o	Couleur : bleu Discord (0x5865F2)
o	Description : liste des timers sous forme de lignes structurÃ©es
o	Footer : RÃ©agissez avec l'emoji correspondant pour annuler un timer
o	Timestamp : affichÃ© automatiquement
6.2 Format des lignes
Chaque timer est affichÃ© sous forme :
ğŸ‡¦ **A** Â· **<texte du timer>**
â”” Timer: <t:timestamp:R> le <t:timestamp:F>
Si le timer est terminÃ© :
ğŸ‡§ **B** Â· ~~<texte du timer>~~
â”” ~~Timer terminÃ© <t:timestamp:R>~~
6.3 Mises Ã  jour automatiques
â€¢	Le message est mis Ã  jour Ã  chaque changement :
o	Ajout, fin ou annulation dâ€™un timer.
â€¢	Si un utilisateur nâ€™a plus de timer â†’ le message rÃ©capitulatif est supprimÃ©.
â€¢	Les rÃ©actions sont nettoyÃ©es et rÃ©appliquÃ©es Ã  chaque mise Ã  jour pour correspondre aux timers actifs.
________________________________________
 7. RÃ©actions et annulation
7.1 Attribution des emojis
Les timers sont associÃ©s aux emojis ğŸ‡¦ Ã  ğŸ‡¾ (jusquâ€™Ã  25 timers par utilisateur).
Exemple :
Timer	Emoji	Lettre
1	ğŸ‡¦	A
2	ğŸ‡§	B
3	ğŸ‡¨	C
7.2 Annulation dâ€™un timer
Quand un utilisateur rÃ©agit :
1.	Le bot identifie quel timer correspond Ã  lâ€™emoji.
2.	Le timer est annulÃ© :
o	clearTimeout() du timer en cours.
o	Suppression du timer de la mÃ©moire.
o	Mise Ã  jour du message rÃ©sumÃ©.
3.	Lâ€™utilisateur reÃ§oit un DM :
4.	âœ… Timer **<texte>** annulÃ©.
5.	La rÃ©action de lâ€™utilisateur est supprimÃ©e pour Ã©viter les doublons.
7.3 Gestion dâ€™erreurs
â€¢	Les rÃ©actions des bots sont ignorÃ©es.
â€¢	Si une rÃ©action ou suppression Ã©choue en DM, le bot logue mais ne bloque pas le flux.
________________________________________
 8. Sauvegarde et rechargement
8.1 Structure du fichier timers.json
{
  "timers": [
    {
      "id": "userId-timestamp",
      "userId": "1234567890",
      "text": "RÃ©union",
      "endTime": 1700000000000,
      "startTime": 1699990000000,
      "ended": false
    }
  ],
  "summaryMessages": [
    {
      "userId": "1234567890",
      "messageId": "0987654321",
      "channelId": "0987654321"
    }
  ]
}
8.2 Persistance
â€¢	Chaque crÃ©ation, mise Ã  jour ou suppression de timer dÃ©clenche un saveTimers().
â€¢	Au dÃ©marrage, loadTimers() recharge :
o	Les timers valides et les reprogramme.
o	Les timers expirÃ©s marquÃ©s comme â€œterminÃ©sâ€.
o	Les messages rÃ©capitulatifs existants.
________________________________________
 9. SÃ©curitÃ© et stabilitÃ©
â€¢	Variables dâ€™environnement requises :
o	DISCORD_BOT_TOKEN
o	DISCORD_CLIENT_ID
â€¢	DÃ©lai de 0.5s entre chaque ajout de rÃ©action pour Ã©viter le rate limit Discord.
â€¢	Gestion dâ€™erreurs robustes sur :
o	Lâ€™accÃ¨s aux DM
o	Lâ€™Ã©dition/suppression de message
o	Le parsing des durÃ©es
â€¢	Aucun timer ou message perdu en cas de redÃ©marrage.
________________________________________
 10. RÃ©sumÃ© du cycle dâ€™usage
1.	Utilisateur â†’ /add-timer texte:"Cours" duree:"2h30m"
2.	Bot â†’ crÃ©e le timer, envoie confirmation, met Ã  jour le message rÃ©capitulatif
3.	Utilisateur â†’ voit le message DM avec ses timers et leurs emojis
4.	Utilisateur â†’ rÃ©agit ğŸ‡¦ â†’ timer annulÃ©, message mis Ã  jour
5.	Timer expire â†’ DM automatique â€œâŒ› terminÃ©â€ + mise Ã  jour du rÃ©sumÃ©
6.	Bot redÃ©marre â†’ recharge les timers et rÃ©capitulatifs existants
